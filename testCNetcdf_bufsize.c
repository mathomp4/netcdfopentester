#include <stdlib.h>
#include <stdio.h>
#include <netcdf.h>
#include <time.h>
#include <math.h>

/* This is the name of the data file we will read. */
#define FILE_NAME1 "MERR.nc3"
#define FILE_NAME2 "MERR.nc4"
#define FILE_NAME3 "MERR.nc5"
#define FILE_NAME4 "MERR.nc6"
#define FILE_NAME5 "MERR.nc7"

#define ITERS 100
#define MAX_POW 20

/* Handle errors by printing an error message and exiting with a
 * non-zero status. */
#define ERRCODE 2
#define ERR(e) {printf("Error: %s\n", nc_strerror(e)); exit(ERRCODE);}

int
main()
{
   /* This will be the netCDF ID for the file and data variable. */
   int ncid1, ncid2, ncid3, ncid4, ncid5;

   /* Loop indexes, and error handling. */
   int x = 0;
   int y = 0;
   int retval;

   clock_t start;
   clock_t finish;

   size_t bfr_sz_hnt;

   start = clock();
   for (x = 0; x < ITERS; x++)
   {
      if ((retval = nc_open(FILE_NAME1, NC_NOWRITE, &ncid1)))
         ERR(retval);
      if ((retval = nc_close(ncid1)))
         ERR(retval);
   }
   finish = clock();
   printf ("nc3 unlimit dim open Time = %6.3f seconds.\n", (double)(finish-start) / CLOCKS_PER_SEC);
   
   start = clock();
   for (x = 0; x < ITERS; x++)
   {
      if ((retval = nc_open(FILE_NAME2, NC_NOWRITE, &ncid2)))
         ERR(retval);
      if ((retval = nc_close(ncid2)))
         ERR(retval);
   }
   finish = clock();
   printf ("nc4 unlimit dim open Time = %6.3f seconds.\n", (double)(finish-start) / CLOCKS_PER_SEC);
   
   bfr_sz_hnt = NC_SIZEHINT_DEFAULT;
   start = clock();
   for (x = 0; x < ITERS; x++)
   {
      if ((retval = nc__open(FILE_NAME2, NC_NOWRITE, &bfr_sz_hnt, &ncid2)))
         ERR(retval);
      if ((retval = nc_close(ncid2)))
         ERR(retval);
   }
   finish = clock();
   printf ("nc4 unlimit dim __open default %d buffer Time = %6.3f seconds.\n", bfr_sz_hnt, (double)(finish-start) / CLOCKS_PER_SEC);

   for (y = 10; y < MAX_POW; y++)
   {
      bfr_sz_hnt = (int)pow(2,y);
      start = clock();
      for (x = 0; x < ITERS; x++)
      {
         if ((retval = nc__open(FILE_NAME2, NC_NOWRITE, &bfr_sz_hnt, &ncid2)))
            ERR(retval);
         if ((retval = nc_close(ncid2)))
            ERR(retval);
      }
      finish = clock();
      printf ("nc4 unlimit dim __open %d buffer Time = %6.3f seconds.\n", bfr_sz_hnt, (double)(finish-start) / CLOCKS_PER_SEC);
   }
   
   
   
}
